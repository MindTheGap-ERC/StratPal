---
title: "Stratigraphic Paleobiology for Event Data"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Stratigraphic Paleobiology for Event Data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```


## Introduction

This vignette provides an introduction to stratigraphic paleobiology applied to "_event type data_" such as location and age of specimens, and first/last occurrences of taxa.

First, let's load the required packages:

```{r setup}
library(StratPal)
library(admtools)
```

## Modeling fossil occurrences and first/last fossil occurrences

Location and age of fossil specimens and first/last occurrences of taxa can be considered distinct events that occur at specific points in time or stratigraphic positions. Up to a few notable exceptions, the same principles apply to this "_event type data_", so we treat them together.

We model events as _point processes_. In the `StratPal` package, we provide two functions to simulate point processes:

* `p3`, short for Poisson point process, to simulate events that occur at a constant rate

* `p3_var_rate` for variable rate Poisson point processes to simulate events that occur at variable rates (e.g. extinction events etc.)

The usage of `p3` is straightforward.

```{r}
# simulate fossil occurrences over one Myr with an average of 8 occurrences per Myr
p3(rate = 15, from = 0, to = 1) |>
  hist(main = "Fossil occurrences",
       xlab = "Time [Myr]",
       ylab = "# Fossils")
```

For `p3_var_rate`, you can pass either a function that specifies the rate to `x`:

```{r}
# return 100 occurrences by setting n parameter
p3_var_rate(x = sin, from = 0, to = 9, n = 100) |>
  hist(xlab = "Time [Myr]", main = "Fossil occurrences")
# note that negative rates (where sin < 0) are ignored
```

Alternatively, you can pass it two vectors `x` and `y`. The rate is then determined by linear interpolation between these vectors. This is equivalent to using the function `approxfun(x,y, rule = 2)` as input for `x`

```{r}
# decline in fossil occurrences from 50 to 0 over 1 Myr
p3_var_rate(x = c(0,1), y = c(50, 0), from = 0, to = 1, f_max = 50) |>
  hist(xlab = "Time [Myr]", main = "Fossil occurrences")
```

Keep in mind that it is only a matter of interpretation whether the "events" produced by `p3` and `p3_var_rate` are age/timing or locations of specimens from one taxon or of first/last occurrences of multiple taxa. The conceptual framework holds for all event type data.

**Task:** Model an "extinction event" with a background rate of 3 species disappearing per Myr, and a peak in extinction rate where the rate is 10-fold increased over an interval of 200 kyr. How distinct is the peak in the histogram, and how much do the results differe due to randomness when you run the analysis multiple times?

## Age-depth models

Throughout this examples, we the age-depth models from 2 km and 12 km offshore in scenario A.

```{r, figures-side, fig.show="hold", out.width="50%", fig.align='left'}
adm_2km = tp_to_adm(t = scenarioA$t_myr,   # 2 km from shore
                h = scenarioA$h_m[,"2km"],
                T_unit = "Myr",
                L_unit = "m")

adm_12km = tp_to_adm(t = scenarioA$t_myr,  # 12 km from shore
                h = scenarioA$h_m[,"12km"],
                T_unit = "Myr",
                L_unit = "m")

plot(adm_2km,       # plot age-depth model 2 km from shore
     lwd_acc = 2,   # plot thicker lines for intervals with sediment accumulation (lwd = line width)
     lty_destr = 0) # don't plot destructive intervals/gaps (lty = line type)
T_axis_lab()        # add time axis label
L_axis_lab()        # add length axis label
title("Age-depth model 2 km from shore")
plot(adm_12km,      # plot age-depth model 12 km from shore
     lwd_acc = 2,   
     lty_destr = 0)
T_axis_lab() 
L_axis_lab() 
title("Age-depth model 12 km from shore")
```

**Task:** Plot the sea level curve for scenarion A, and the water depth curves at the two locations. How is this connected to the age-depth models, specifically to the presence and duration of gaps and low/high sedimentation rates? You can use `plot_sed_rate_t`, `get_hiat_list` and `get_hiat_duration` from `admtools`.

## Stratigraphic distortions of "event" type data

Any event type of data can directly be transformed using an age-depth model via `time_to_strat`. Depending on how the events are interpreted, we need to choose different options. 

### Fossil specimens

Assuming the events are fossil specimens of one taxon, we can examine where specimens appear in the stratigraphic column:

```{r}
p3(rate = 200, from = min_time(adm_2km), to = max_time(adm_2km)) |>
  time_to_strat(adm_2km, destructive = TRUE) |>
  hist(xlab = "Stratigraphic height [m]",
       main = "Fossil abundance 2 km offshore",
       ylab = "# Fossils",
       breaks = seq(from = min_height(adm_2km), to = max_height(adm_2km), length.out = 20))
```

Note the option `destructive = TRUE` in `time_to_strat`. This is because we assume specimens that lived during a hiatus are destroyed.

Assuming the same rate of fossil specimens, we get a very different pattern 12 km from shore:

```{r}
p3(rate = 200, from = min_time(adm_12km), to = max_time(adm_12km)) |>
  time_to_strat(adm_12km, destructive = TRUE) |>
  hist(xlab = "Stratigraphic height [m]",
       main = "Fossil abundance 12 km offshore",
       ylab = "# Fossils",
       breaks = seq(from = min_height(adm_12km), to = max_height(adm_12km), length.out = 20))
```

Not only is the section much shorter (not even 20 m), but there are 2 distinct peaks at the bottom of the section and around 13 m. Comparing with the age-depth model shows that these locations correspond to times of extreme stratigraphic condensation (low sedimentation rates, indicated by a near-horizontal age-depth model). As a result, more time is represented per stratigraphic increment, leading to accumulations of fossil occurrences (Hohmann 2021).

### First/Last occurrences of common taxa

In the fossil record, we can not directly observe origination and extinction rates of taxa, but only their first and last occurrences. This type of event data can also directly be transformed using `time_to_strat` when taxa are very common. This assumption will be explored further below.

```{r}
p3(rate = 200, from = min_time(adm_2km), to = max_time(adm_2km)) |>
  time_to_strat(adm_2km, destructive = FALSE) |>
  hist(xlab = "Stratigraphic height [m]",
       main = "Last occurrences 2 km offshore",
       breaks = seq(from = min_height(adm_2km), to = max_height(adm_2km), length.out = 20))
```

This would be the pattern of last occurrences in the section 2 km offshore when the rate of last occurrences is constant! The peaks coincide with the hiatuses, as the last occurrences of the species that disappear during the hiatus cluster at the hiatus surface. Note here that we used the option `destructive = FALSE` for `time_to_strat` to make sure the last occurrences appear at the location of the hiatus. This is why the assumption of abundant taxa is important: If taxa are rare, their last occurrence does not match their actual time of extinction (Signor-Lipps effect), and the last occurrences can be found further below the hiatus.

The patter 12 km offshore is very different:

```{r}
p3(rate = 200, from = min_time(adm_12km), to = max_time(adm_12km)) |>
  time_to_strat(adm_12km, destructive = TRUE) |>
  hist(xlab = "Stratigraphic height [m]",
       main = "Last occurrences 12 km offshore",
       breaks = seq(from = min_height(adm_12km), to = max_height(adm_12km), length.out = 20))
```

It almost perfectly matches the pattern of the fossil occurrences. This is because the offshore section is much more dominated by condensation (which influences both fossil occurrences and first/last occurrences equally), while the onshore section is dominated by hiatuses (which affect first/last occurrences). This shows it is important to understand how "event" type data is affected by hiatuses: is it preserved, or is it destroyed?

### Range offset

```{r}
t_ext = 1.5 # time of "true" extinction
r = 30 # rate of fossil occurrences
# simulate rate fossil occurrences of taxon 
f_occ = p3(r, from = min_time(adm_2km), to = t_ext)
hist(f_occ)

# stratigraphically highest fossil found
highest_occ = f_occ |>
  time_to_strat(adm_2km, destructive = TRUE) |> # destroy fossil occurrences
  max(na.rm = TRUE)

# stratigraphic position of "true" extinction
h_true_ext = t_ext |>
  time_to_strat(adm_2km, destructive = FALSE) 

# distance between last occurence of taxon and location where they actually go extinct
strat_range_offset_m = h_true_ext - highest_occ

# time when last preserved fossil lived
t_last_occ = highest_occ |> 
  strat_to_time(adm_2km)

# time offset between true extinction and time when last fossil lived.
time_range_offset_myr = t_ext - t_last_occ
```



```{r}
dist = scenarioA$dist_from_shore[2]

# define age-depth model and attach units to it
adm = tp_to_adm(t = scenarioA$t_myr,
                h = scenarioA$h_m[,dist],
                T_unit = "Myr",
                L_unit = "m")
# plot age-depth model
plot(adm,
     lwd_acc = 2,   # plot thicker lines for accumulative intervals (lwd = line width)
     lty_destr = 0) # don't plot destructive intervals (lty = line type)
T_axis_lab() # add time axis label
L_axis_lab() # add length axis label
```

```{r}
p3(rate = 100, from = min_time(adm), to = max_time(adm)) |>                  # simulate fossil occurrences in time
  get_height(adm, t = _, destructive = FALSE) |>    #   transfrom into depth domain
  hist(breaks = seq(min_height(adm), to = max_height(adm), length.out = 20),
      main = "Fossil occurrences",
       xlab = "Height [m]")
```


## Influence of niches

We increase the complexity of the pipeline by incorporating niche modeling. For this we need two components:

* a niche definition that describes how "comfortable" a species feels along an environmental gradient

* information on how that gradient changes with time

In this example we focus on _water depth_ as gradient as it is included in the model outputs. The general modeling framework works for any type of gradient.

First, we define the niche. We do this using the helper function `cnd` (capped normal distribution). It is a probability density function of the normal distribution, multiplied by the factor `inc` and capped at 1. A 1 reflects that the taxon is fully within its prefferred environment, and a 0 reflects that is is outside of its environment.
```{r}
my_niche = cnd(mean = 10, # preffered water depth 
               sd = 5, # tolerance to water depth fluctiations
               inc = 15, # multiplier
               cut_neg = TRUE) # cut off negative avalues - the species does not surviva at land
x = seq(-2, 30, by = 0.1)
plot(x, my_niche(x), type = "l", xlab = "water depth", ylab = "preference")
```

To get the gradient change with time, we extract water depth 2 km offshore from the example data:

```{r}
t = scenarioA$t_myr
wd = scenarioA$wd_m[,"2km"]
gc = approxfun(t, wd) # define gradient change
plot(t, gc(t), type = "l", xlab = "Time [Myr]", ylab = "Water depth [m]")

```

Now we can combine these two ingredients to examine how the preffered niche changes the fossil abundance in the time domain.

```{r}
p3(rate = 300, from = min_time(adm_2km), to = max_time(adm_2km)) |>
  apply_niche_pref(niche_def = my_niche, gc = gc) |>
  hist(xlab = "Time [Myr]", main = "Fossil abundance")
```

Here you can see that the taxon only occurs at times where the water depth is favorable for it. Around 2 Myr, the water depth is too shallow, and the fossil abundance is reduced.

With the basic niche modeling done, we can now combine it with the stratigrahic distortion by age-depth models to get an idea how niche preferences change the fossil abundance in the section.

```{r}
p3(rate = 300, from = min_time(adm_2km), to = max_time(adm_2km)) |>
  apply_niche_pref(niche_def = my_niche, gc = gc) |>
  time_to_strat(adm_2km, destructive = TRUE) |>
  hist(xlab = "Stratigraphic height [m]",
       main = "Fossil abundance")

```

We can see a general decrease in fossil abundance, but no longer gaps as were visible in the time domain. The latter is because the gaps in fossil abundance in the time domain coincide with hiatuses, and will thus not be visible in the stratigraphic domain. The general decrease in fossil abundance is because as the carbonate platform ages, the water depth on the platform is decreasing:

```{r}
list("t" = t, "y" = wd) |>
  time_to_strat(adm_2km) |> 
  plot(orientation = "lr", type = "l", xlab = "Stratigraphic position [m]", ylab = "Water depth [m]")
```

## Further reading

Go to

```{r, eval=FALSE}
vignette("phenotypic_evolution")
```

for details on how to model stratigraphic paleobiology of phenotypic evolution, or explore the vignette online under ([mindthegap-erc.github.io/StratPal/articles/phenotypic_evolution](https://mindthegap-erc.github.io/StratPal/articles/phenotypic_evolution.html)).

See also

```{r, eval=FALSE}
vignette("advanced_functionality")
```

for details on how to expand on the modeling pipelines described here, or explore the vignette online under ([mindthegap-erc.github.io/StratPal/articles/advanced_functionality](https://mindthegap-erc.github.io/StratPal/articles/advanced_functionality.html)).

## Reference

* NIKLAS HOHMANN; INCORPORATING INFORMATION ON VARYING SEDIMENTATION RATES INTO PALEONTOLOGICAL ANALYSES. PALAIOS 2021;; 36 (2): 53â€“67. doi: https://doi.org/10.2110/palo.2020.038
